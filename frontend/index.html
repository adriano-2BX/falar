<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue3-apexcharts"></script>

    <style type="text/tailwindcss">
        /* Podemos adicionar estilos customizados e animações aqui */
        @layer utilities {
            .animate-pulse-slow {
                animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse-slow {
                50% {
                    opacity: .8;
                }
            }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="app" class="min-h-screen p-4 sm:p-8">
        
        <h1 class="text-4xl font-bold text-center text-gray-100 mb-8 tracking-wider">
            SYSTEM STATUS DASHBOARD
        </h1>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            <server-card v-for="server in servers" :key="server.id" :server="server"></server-card>
        </div>

    </div>

    <script>
        // Desestruturamos as funções que vamos usar do objeto global 'Vue'
        const { createApp, ref, onMounted, computed } = Vue;
        
        // Criamos nossa aplicação Vue
        const app = createApp({
            setup() {
                // 'ref' cria uma variável reativa. Qualquer mudança aqui, a UI atualiza automaticamente.
                const servers = ref([]);

                // Inicializa o painel com 20 servidores em estado padrão
                for (let i = 1; i <= 20; i++) {
                    servers.value.push({
                        id: i,
                        name: `SRV-${String(i).padStart(2, '0')}`,
                        status: 'normal',
                        cpu_load: 0,
                        ram_usage: 0,
                        disk_space: 0,
                        uptime: "initializing...",
                        last_error: null
                    });
                }

                // 'onMounted' é executado quando a aplicação é carregada na tela
                onMounted(() => {
                    // A URL deve apontar para o seu backend FastAPI
                    // Se estiver testando localmente, use http://localhost:8000/stream
                    const eventSource = new EventSource('/stream');

                    eventSource.onmessage = (event) => {
                        console.log("SSE Event Received:", event.data);
                        const data = JSON.parse(event.data);

                        if (data.action === 'update_server') {
                            const serverIndex = servers.value.findIndex(s => s.id === data.payload.id);
                            if (serverIndex !== -1) {
                                // Atualiza os dados do servidor encontrado. Vue cuida do resto!
                                servers.value[serverIndex] = data.payload;
                            }
                        }
                    };

                    eventSource.onerror = (err) => {
                        console.error("EventSource failed:", err);
                    };
                });

                // Expomos a variável 'servers' para o template HTML
                return {
                    servers
                };
            }
        });
        
        // --- DEFINIÇÃO DO COMPONENTE 'ServerCard' ---
        app.component('ServerCard', {
            // Este componente usa o 'vue3-apexcharts' que carregamos via CDN
            components: {
                apexchart: VueApexCharts,
            },
            props: ['server'],
            setup(props) {
                // Lógica para mudar a classe CSS principal do card
                const cardClasses = computed(() => ({
                    'bg-red-500/80 border-red-400 animate-pulse': props.server.status === 'down',
                    'bg-yellow-500/80 border-yellow-400 animate-pulse-slow': props.server.status === 'overloaded',
                    'bg-gray-800/60 border-gray-700': props.server.status === 'normal'
                }));
                
                // Opções para o gráfico
                const chartOptions = computed(() => ({ /* ... opções do gráfico ... */ }));
                const series = computed(() => [props.server.cpu_load || 0]);

                return { cardClasses, chartOptions, series };
            },
            // O template HTML do nosso componente
            template: `
                <div class="p-4 rounded-xl shadow-lg text-white transform hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 border backdrop-blur-sm"
                    :class="cardClasses">
                    
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">{{ server.name }}</h3>
                        <span class="text-xs font-mono px-2 py-1 rounded"
                            :class="{
                                'bg-green-500/20 text-green-300': server.status === 'normal',
                                'bg-yellow-500/20 text-yellow-300': server.status === 'overloaded',
                                'bg-red-500/20 text-red-300': server.status === 'down'
                            }">
                            {{ server.status.toUpperCase() }}
                        </span>
                    </div>

                    <div class="text-center my-4 opacity-90">
                        <apexchart type="radialBar" height="130" :options="chartOptions" :series="series"></apexchart>
                        <div class="text-center -mt-4 text-xs font-semibold tracking-wider">CPU LOAD</div>
                    </div>
                    
                    <div class="text-xs space-y-1 opacity-80 font-mono">
                        <div class="flex justify-between border-b border-gray-700/50 py-1">
                            <span>RAM</span> <span>{{ server.ram_usage || 0 }}%</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700/50 py-1">
                            <span>Disco</span> <span>{{ server.disk_space || 0 }}%</span>
                        </div>
                        <div class="flex justify-between pt-1">
                            <span>Uptime</span> <span>{{ server.uptime }}</span>
                        </div>
                    </div>

                    <div v-if="server.last_error" class="mt-4 text-center bg-red-900/50 p-2 rounded-lg text-xs font-mono">
                        ⚠️ {{ server.last_error }}
                    </div>
                </div>
            `
        });
        
        // Monta a aplicação Vue na div #app
        app.mount('#app');

    </script>
</body>
</html>
