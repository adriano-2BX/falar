<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Alerta</title>
    <style>
        /* Estilos básicos para o modal e overlay */
        body { font-family: sans-serif; background-color: #f0f0f0; }
        #overlay { position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 2; cursor: pointer; }
        #alert-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 30px; border-radius: 10px; z-index: 3; text-align: center; border: 5px solid red; }
        #alert-modal h2 { margin-top: 0; color: red; }
        #alert-modal button { margin-top: 20px; padding: 10px 20px; }
    </style>
</head>
<body>
    <h1>Painel de Alerta</h1>
    <p>Status: <span id="status">Desconectado</span></p>

    <div id="overlay"></div>
    <div id="alert-modal">
        <h2>ALERTA!</h2>
        <p id="alert-message">Esta é uma mensagem de alerta.</p>
        <button onclick="fecharAlerta()">Fechar</button>
    </div>

    <audio id="siren-sound" src="/sirene.mp3" loop></audio>

    <script>
        const statusEl = document.getElementById('status');
        const overlay = document.getElementById('overlay');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const sirenSound = document.getElementById('siren-sound');

        // --- Conexão WebSocket ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

        ws.onopen = () => {
            statusEl.textContent = "Conectado";
            statusEl.style.color = "green";
        };

        ws.onclose = () => {
            statusEl.textContent = "Desconectado. Tentando reconectar...";
            statusEl.style.color = "red";
            // Tenta reconectar a cada 3 segundos
            setTimeout(() => window.location.reload(), 3000);
        };

        ws.onerror = (error) => {
            console.error("WebSocket Error:", error);
            statusEl.textContent = "Erro na conexão";
        };

        // A parte mais importante: ouvir mensagens do servidor
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Comando recebido:", data);

            // Decide o que fazer com base na ação recebida
            switch (data.action) {
                case 'speak':
                    falar(data.payload);
                    break;
                case 'alert':
                    mostrarAlerta(data.payload);
                    break;
                case 'siren':
                    if (data.payload === 'play') {
                        tocarSirene();
                    } else if (data.payload === 'stop') {
                        pararSirene();
                    }
                    break;
            }
        };

        // --- Funções de Ação do Frontend ---

        function falar(texto) {
            // Usa a API de Fala do Navegador
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'pt-BR';
                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Navegador não suporta Text-to-Speech.");
            }
        }

        function mostrarAlerta(mensagem) {
            alertMessage.textContent = mensagem;
            overlay.style.display = 'block';
            alertModal.style.display = 'block';
        }

        function fecharAlerta() {
            overlay.style.display = 'none';
            alertModal.style.display = 'none';
            pararSirene(); // Opcional: parar a sirene ao fechar o modal
        }

        function tocarSirene() {
            sirenSound.play().catch(e => console.error("Erro ao tocar sirene:", e));
        }
        
        function pararSirene() {
            sirenSound.pause();
            sirenSound.currentTime = 0; // Reinicia o áudio
        }

    </script>
</body>
</html>
