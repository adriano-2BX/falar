<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Alerta</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; }
        #status-box { padding: 15px; border-radius: 5px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .status-disconnected { background-color: #ffebee; color: #c62828; }
        .status-connected { background-color: #e8f5e9; color: #2e7d32; }
        #overlay { position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 2; cursor: pointer; }
        #alert-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 30px; border-radius: 10px; z-index: 3; text-align: center; border: 5px solid red; }
        #alert-modal h2 { margin-top: 0; color: red; }
        #alert-modal button { margin-top: 20px; padding: 10px 20px; }
    </style>
</head>
<body>
    <h1>Painel de Alerta</h1>
    <div id="status-box">Status: <span id="status">Iniciando...</span></div>

    <audio id="siren-sound" src="/static/sirene.mp3" loop></audio>
    
    <div id="overlay"></div>
    <div id="alert-modal">
        <h2>ALERTA!</h2>
        <p id="alert-message">Esta é uma mensagem de alerta.</p>
        <button onclick="fecharAlerta()">Fechar</button>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const statusBox = document.getElementById('status-box');
        
        console.log("Iniciando conexão com Server-Sent Events...");
        
        // --- ATUALIZAÇÃO IMPORTANTE AQUI ---
        // Trocamos WebSocket por EventSource
        const eventSource = new EventSource("/stream");

        // Evento quando a conexão é aberta com sucesso
        eventSource.onopen = () => {
            console.log("Conexão SSE estabelecida.");
            statusBox.className = 'status-box status-connected';
            statusEl.textContent = "Conectado";
        };

        // Evento quando uma nova mensagem chega do servidor
        eventSource.onmessage = (event) => {
            // A mensagem já vem em 'event.data'
            const data = JSON.parse(event.data);
            console.log("Comando SSE recebido:", data);

            switch (data.action) {
                case 'speak':
                    falar(data.payload);
                    break;
                case 'alert':
                    mostrarAlerta(data.payload);
                    break;
                case 'siren':
                    if (data.payload === 'play') tocarSirene();
                    else if (data.payload === 'stop') pararSirene();
                    break;
            }
        };

        // Evento se ocorrer um erro. O navegador tentará reconectar automaticamente.
        eventSource.onerror = (err) => {
            console.error("Erro no EventSource:", err);
            statusBox.className = 'status-box status-disconnected';
            statusEl.textContent = "Conexão perdida. Tentando reconectar...";
        };
        
        // As funções de ação não mudam
        function falar(texto) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(texto); u.lang = 'pt-BR'; window.speechSynthesis.speak(u); } }
        function mostrarAlerta(mensagem) { document.getElementById('alert-message').textContent = mensagem; document.getElementById('overlay').style.display = 'block'; document.getElementById('alert-modal').style.display = 'block'; }
        function fecharAlerta() { document.getElementById('overlay').style.display = 'none'; document.getElementById('alert-modal').style.display = 'none'; pararSirene(); }
        function tocarSirene() { document.getElementById('siren-sound').play().catch(e => console.error("Erro ao tocar sirene:", e)); }
        function pararSirene() { const s = document.getElementById('siren-sound'); s.pause(); s.currentTime = 0; }
    </script>
</body>
</html>
